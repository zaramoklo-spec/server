services:
  mongodb:
    image: mongo:7.0
    container_name: RATPanel_mongodb
    restart: always
    volumes:
      - mongodb_data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: ownerapps
      MONGO_INITDB_ROOT_PASSWORD: 9kiwlPwQ2ICpc1F
      MONGO_INITDB_DATABASE: RATPanel
    ports:
      - "27017:27017"
    command: mongod --wiredTigerCacheSizeGB 16 --maxConns 1000
    networks:
      - parental_network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/RATPanel --quiet
      interval: 10s
      timeout: 5s
      retries: 5
  
  redis:
    image: redis:7-alpine
    container_name: RATPanel_redis
    restart: always
    # Optimized Redis configuration for production
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --replicaof no one
      --tcp-backlog 511
      --timeout 300
      --tcp-keepalive 60
      --maxclients 10000
      --save 900 1
      --save 300 10
      --save 60 10000
      --stop-writes-on-bgsave-error no
      --rdbcompression yes
      --rdbchecksum yes
      --lazyfree-lazy-eviction yes
      --lazyfree-lazy-expire yes
      --lazyfree-lazy-server-del yes
      --replica-lazy-flush yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - parental_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 768M
        reservations:
          cpus: '0.5'
          memory: 512M
  
  api:
    build:
      context: .
      dockerfile: Dockerfile.prod
    container_name: RATPanel_api
    restart: always
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - MONGODB_URL=mongodb://ownerapps:9kiwlPwQ2ICpc1F@mongodb:27017/RATPanel?authSource=admin
      - MONGODB_DB_NAME=RATPanel
      - REDIS_URL=redis://redis:6379/0
      - SERVER_PORT=80
      - GUNICORN_WORKERS=9
      - GUNICORN_WORKER_CONNECTIONS=2000
      - GUNICORN_MAX_REQUESTS=1000
      - GUNICORN_TIMEOUT=120
      - LOG_LEVEL=info
      - BACKUP_DIR=/app/backups
    volumes:
      - backup_data:/app/backups
    ports:
      - "80:80"
    networks:
      - parental_network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:80/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  
  fcm_ping_worker_v2:
    build:
      context: .
      dockerfile: Dockerfile.prod
    container_name: RATPanel_fcm_worker_v2
    restart: always
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      api:
        condition: service_started
    environment:
      - MONGODB_URL=mongodb://ownerapps:9kiwlPwQ2ICpc1F@mongodb:27017/RATPanel?authSource=admin
      - MONGODB_DB_NAME=RATPanel
      - REDIS_URL=redis://redis:6379/0
      - WORKER_ID=worker-1
      - WORKER_CONCURRENCY=10
    networks:
      - parental_network
    command: python scripts/fcm_ping_worker_v2.py
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '1'
          memory: 512M
  
networks:
  parental_network:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
  redis_data:
    driver: local
  backup_data:
    driver: local
