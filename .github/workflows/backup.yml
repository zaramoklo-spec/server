name: Repository Backup to Telegram

on:
  push:
    branches: [main, master, develop]
    paths-ignore:
      - '*.md'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for complete backup
      
      - name: Create ZIP archive
        run: |
          ZIP_NAME="server-backup-$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:7}.zip"
          zip -r "$ZIP_NAME" . \
            -x "*.git/*" \
            -x "*.github/workflows/*.yml.bak" \
            -x "*/.DS_Store" \
            -x "*/build/*" \
            -x "*/node_modules/*" \
            -x "*/__pycache__/*" \
            -x "*/.pytest_cache/*" \
            -x "*/venv/*" \
            -x "*/.venv/*" \
            -x "*/backups/*" \
            -x "*.pyc" \
            -x "*.pyo" \
            -x "*.pyd" \
            -x ".env" \
            -x ".env.*"
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          echo "ZIP_SIZE=$(du -h $ZIP_NAME | cut -f1)" >> $GITHUB_ENV
      
      - name: Send backup to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN || '8312138474:AAHSLslHtfLEwRM-oKae-YOuxpMEKKJo5Hs' }}
          TELEGRAM_CHAT_ID: -1003591352604
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_HASH=$(git log -1 --pretty=%h)
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          BACKUP_TIME=$(date +"%Y-%m-%d %H:%M:%S UTC")
          
          CAPTION="ğŸ“¦ Repository Backup - Server
          
          ğŸ“ File: ${{ env.ZIP_NAME }}
          ğŸ“Š Size: ${{ env.ZIP_SIZE }}
          
          ğŸ”€ Branch: $BRANCH_NAME
          ğŸ‘¤ Author: $COMMIT_AUTHOR
          ğŸ’¬ Commit: $COMMIT_MSG
          ğŸ”– Hash: $COMMIT_HASH
          ğŸ• Time: $BACKUP_TIME
          
          ğŸ”— Repository: ${{ github.repository }}
          ğŸ†” Run ID: ${{ github.run_id }}
          ğŸ”— Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -F document=@"${{ env.ZIP_NAME }}" \
            -F caption="$CAPTION" \
            -F parse_mode=HTML \
            https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument?chat_id=${TELEGRAM_CHAT_ID}
      
      - name: Cleanup
        if: always()
        run: |
          rm -f *.zip
